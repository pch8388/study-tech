# 개요
- 서버의 지표들을 카프카로 수집하는 데이터 파이프라인을 만들고 적재된 데이터를 실시간 처리하는 로직 개발
- 카프카는 불특정 다수의 서버의 지표를 수집하는 데에 아주 적합
  - 클러스터를 스케일 아웃하거나 파티션을 늘림으로써 변화하는 데이터 양에 유연하게 대응하여 스트리밍 데이터 처리

## 요구 사항
- cpu와 메모리 데이터를 수집하여 토픽으로 전송
  - cpu 사용량이 50%가 넘을 경우 지표 데이터 중 hostname과 timestamp 정보를 비정상 CPU 토픽으로 전송
- 서버 지표 수집에는 메트릭비트(metricbeat) 활용
  - 메트릭비트는 각종 지표들을 수집하고 카프카 모듈을 통해 카프카로 전송할 수 있음
  - 메트릭비트가 서버 지표 수집과 프로듀서 역할을 동시에 수행
- 수집된 서버 지표 데이터를 실시간 처리하는 데는 카프카 스트림즈 사용
  - 카프카 스트림즈는 별개의 클러스터가 필요하지 않고 독립된 자바 애플리케이션으로써 동작 => 운영하는 데 큰 리소스가 들지 않음

## 정책 및 기능 정의
### 적재 정책
- 서버 지표를 수집할 때 중요한 것은 무중단성
  - 브로커에 장애가 발생하여도 모니터링은 지속적으로 이루어져야 함
  - 따라서 지표 적재시에는 지속적으로 데이터를 처리할 수 있으면서도 일부 데이터가 유실되거나 중복될 가능성을 염두에 두어야 함

### 토픽
- 전체 서버의 지표들을 저장하는 토픽
- CPU 지표만 저장하는 토픽
- 메모리 지표만 저장하는 토픽
- 비정상 CPU 지표 정보를 저장하는 토픽

> 데이터 처리 순서보다는 처리량을 늘리는 것이 중요하기 때문에 메시지 키는 사용하지 않음

### 메트릭비트
- 서버 지표 수집을 위해 시스템 모듈 사용
  - cpu, 메모리, 네트워크, 프로세스 등의 지표 수집
  - 수집 간격을 10초 정도로 설정하여 데이터가 과도하게 수집되지 않게 설정 => 환경에 따라 다르게 설정해야 할 것 같음. 변화파악이 빠르게 필요하면 수집 간격을 짧게 가져가야 할 듯

### 카프카 스트림즈
- 수집된 서버의 지표 데이터를 분기처리하고 필터링하는 동작은 카프카 스트림즈가 최적


## 기능 구현
### 메트릭비트 설치 및 설정
```bash
# 설치
$ brew install metricbeat

# 설치된 위치 확인
$ brew info metricbeat

# 설정값 입력
$ cd 위에서나온주소
$ vi metricbeat.yml
####
metricbeat.modules:
- module: system
  metricsets:
    - cpu
    - memory
  enabled: true
  period: 10s

output.kafka:
  hosts: ["my-kafka:9092"]
  topic: 'metric.all'
####
```