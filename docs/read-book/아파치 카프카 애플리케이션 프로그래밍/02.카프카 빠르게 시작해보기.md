# AWS 인스턴스 생성
OS 이미지 선택
<img width="761" alt="스크린샷 2022-06-13 오전 11 24 24" src="https://user-images.githubusercontent.com/17218212/173269756-4130d10d-49e5-47d6-8fc2-add1f56496dc.png">

인스턴스 유형 선택
<img width="750" alt="스크린샷 2022-06-13 오전 11 24 31" src="https://user-images.githubusercontent.com/17218212/173269775-1dbad3c0-f760-4204-bb19-6708be82cf85.png">

키페어 생성
<img width="729" alt="스크린샷 2022-06-13 오전 11 24 36" src="https://user-images.githubusercontent.com/17218212/173269778-6da6db11-e0f8-4e6d-86d5-c48dcf0b62da.png">

인바운드 규칙 설정
- 카프카 브로커 : 9092
- 주키퍼 : 2181
<img width="1409" alt="스크린샷 2022-06-13 오전 11 34 09" src="https://user-images.githubusercontent.com/17218212/173269780-61721ebe-476e-4395-9c7f-8dc7412f6c6c.png">

# 인스턴스에 접속
## ssh 명령어로 접속
생성한 키페어는 read 권한만 있어야 하기 때문에 권한을 변경
```bash
chmod 400 kafka-study.pem
```

ssh 접속
```bash
ssh -i kafka-study.pem <유저id>@<퍼블릭IP>
```

## java 설치
카프카 브로커 실행을 위해 java 설치 필요
```bash
sudo yum install -y java-1.8.0-openjdk-devel.x86_64

# 제대로 설치되었는지 버전 확인
java -version 
```

## 주키퍼, 카프카 브로커 실행
카프카 [다운로드](https://kafka.apache.org/downloads) 링크에서 다운로드 링크를 복사해서 wget 명령어로 다운받는다
```bash
wget https://archive.apache.org/dist/kafka/2.5.0/kafka_2.12-2.5.0.tgz

# 압축 해제
tar xvf kafka_2.12-2.5.0.tgz

cd kafka_2.12-2.5.0/
```

> 카프카 브로커는 레코드의 내용은 페이지 캐시로 시스템 메모리 사용하고, 나머지 객체는 힙 메모리에 저장하여 사용하기 때문에 카프카 브로커 운영시 힙 메모리를 5GB 이상으로 설정하지 않는 것이 일반적이다

### 카프카 힙메모리 설정
```bash
export KAFKA_HEAP_OPTS="-Xmx400m -Xms400m"
echo $KAFKA_HEAP_OPTS
```

- kafka-server-start.sh 에서 시작 스크립트 확인 가능
- `-daemon` 옵션을 사용하여 카프카 브로커가 백그라운드로 실행되게 할 수 있다

### 카프카 브로커 실행 옵션 설정
`config/server.properties` 파일에 카프카 브로커가 클러스터 운영에 필요한 옵션들 지정
- advertised.listener : 카프카 클라이언트 또는 커맨드 라인 툴을 브로커와 연결할 때 사용
  - `advertised.listener=PLAINTEXT://퍼블릭IP:9092`
- 이미 실행되고 있는 카프카 브로커의 설정을 변경하려면 브로커를 재시작해야 함

|옵션이름|설명|
|--|--|
|broker.id|카프카 브로커 ID|
|listeners|카프카 브로커가 통신을 위해 열어둘 인터페이스 IP, port, 프로토콜 설정|
|advertised.listeners|카프카 클라이언트나 커맨드 라인 툴에서 접속할때 사용하는 IP, port 정보|
|listener.security.protocol.map|SASL_SSL, SASL_PLAIN 보안 설정 시 프로토콜 매핑 설정|
|num.network.threads|네트워크 스레드 개수 설정|
|num.io.threads|카프카 브로커 내부에서 사용할 스레드 개수|
|log.dirs|통신을 통해 가져온 데이터를 파일로 저장할 디렉터리 위치, 브로커 실행전에 생성이 되어 있어야 함|
|num.partitions|파티션 개수를 명시하지 않고 토픽 생성 시 기본 설정되는 파티션 개수|
|log.retention.hours|브로커가 저장한 파일이 삭제되기까지 걸리는 시간. log.retention.ms로 값을 지정하여 설정하는 것을 추천. -1로 지정하면 영원히 삭제되지 않음|
|log.segment.bytes|브로커가 저장할 파일의 최대 크기 지정. 여기서 설정한 크기를 넘게 되면 새로운 파일이 생성됨|
|log.retention.check.interval.ms|브로커가 저장한 파일을 삭제하기 위해 체크하는 간격 지정|
|zookeeper.connect|브로커와 연동할 주키퍼의 IP, port 설정|
|zookeeper.connection.timeout.ms|주키퍼의 세션 타임아웃 시간|