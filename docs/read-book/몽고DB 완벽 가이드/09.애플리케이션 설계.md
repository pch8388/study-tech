# 스키마 설계 고려 사항
- 애플리케이션에서 요구하는 데이터의 형태로 설계하는 것이 가장 좋은 방법
- RDB와는 달리 스키마 모델링보다 query 및 data access pattern 을 분석해야 한다

## 스키마 설계시 고려할 주요 요소
- 제약사항
  - 도큐먼트의 최대 크기는 16MB
  - 디스크에서 전체 도큐먼트를 읽고 씀 => update는 전체 도큐먼트를 다시 쓰고, atomit update 는 도큐먼트 레벨로 이루어진다
- 쿼리 및 쓰기의 접근 패턴
  - 읽기와 쓰기 빈도를 파악하고, 어떤 쿼리가 가장 많이 실행될지 파악해야 한다
- 관계 유형
  - 애플리케이션 요구 사항과 도큐먼트 관계를 파악하여 데이터나 도큐먼트를 내장하거나 참조할 방법을 결정
- 카디널리티
  - 개체가 개별적으로 접근되는지 혹은 상위 개체의 컨텍스트에서만 접근되는지 등에 대해 고려해야 하고, 해당 데이터 필드에 대한 읽기 갱신 비율도 고려해야 한다
    - 이러한 문제에 대한 답이 도큐먼트 간에 데이터를 비정규화할지, 도큐먼트를 내장하거나 참조할지 결정하는 데 도움이 된다

## 스키마 설계 패턴
### 다형성 패턴
컬렉션 내 도큐먼트들이 구조가 비슷하지만 동일하지 않은 경우 => 공통 필드가 다수 있는 경우

### 속성 패턴
- 속성패턴 사용하는 경우
  1. 정렬하거나 쿼리하려는 도큐먼트에 필드의 서브셋이 있는 경우
  2. 정렬하려는 필드가 도큐먼트의 서브셋에만 존재하는 경우
  3. 1, 2 모두 해당하는 경우

```javascript
// release 날짜를 검색하기 위해서는 여러 필드를 살펴보아야 함
{
    title: "Star Wars",
    director: "George Lucas",
    ...
    release_US: ISODate("1977-05-20T01:00:00+01:00"),
    release_France: ISODate("1977-10-19T01:00:00+01:00"),
    release_Italy: ISODate("1977-10-20T01:00:00+01:00"),
    release_UK: ISODate("1977-12-27T01:00:00+01:00"),
    ...
}

// 정보의 서브셋을 배열로 만드르어 인덱싱 요구사항을 줄임
{
    title: "Star Wars",
    director: "George Lucas",
    ...
    releases: [
        {
        location: "USA",
        date: ISODate("1977-05-20T01:00:00+01:00")
        },
        {
        location: "France",
        date: ISODate("1977-10-19T01:00:00+01:00")
        },
        {
        location: "Italy",
        date: ISODate("1977-10-20T01:00:00+01:00")
        },
        {
        location: "UK",
        date: ISODate("1977-12-27T01:00:00+01:00")
        },
        ...
    ],
    ...
}

// 인덱스를 만들어 쿼리 효율을 높일 수 있음
{ "releases.location": 1, "releases.date": 1}
```

### 버킷 패턴
- 일정 기간동안 스트림으로 유입되는 시계열 데이터에 적합
- 시간 데이터 등을 일정하게 나누어 버킷화하면 효과적으로 사용

```javascript
{
    sensor_id: 12345,
    start_date: ISODate("2019-01-31T10:00:00.000Z"),
    end_date: ISODate("2019-01-31T10:59:59.000Z"),
    measurements: [
       {
       timestamp: ISODate("2019-01-31T10:00:00.000Z"),
       temperature: 40
       },
       {
       timestamp: ISODate("2019-01-31T10:01:00.000Z"),
       temperature: 40
       },
       ...
       {
       timestamp: ISODate("2019-01-31T10:42:00.000Z"),
       temperature: 42
       }
    ],
   transaction_count: 42,
   sum_temperature: 2413
}
```

### 이상치 패턴
- 드물게 도큐먼트의 쿼리가 애플리케이션의 정상적인 패턴을 벗어날 때 사용
- flag를 사용해(사용자가 지정한 키) 해당 도큐먼트가 outlier 임을 나타내고, 애플리케이션에서 추가 검색을 하도록 처리할 수 있다

