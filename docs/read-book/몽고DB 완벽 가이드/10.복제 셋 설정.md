# Replication
데이터의 동일한 복사본을 여러 서버상에서 보관하는 방법  
- 프라이머리 서버 : 클라이언트의 요청을 처리 - 한대
- 세컨더리 서버 : 프라이머리를 복제 - 여러대
  - 프라이머리에서 장애가 발생하면 세컨더리 서버 중 새로운 프라이머리 서버를 선출(elect)

# 복제셋 설정
운영 환경에서는 항상 복제 셋을 사용하여 각 멤버에 전용 호스트를 할당해 리소스 경합을 방지하고 서버 오류에 대한 격리를 제공해야 함

## 복제셋 설정해보기
```bash
# docker image pull
$ docker pull mongo

# create network
$ docker network create my-mongo-cluster

# create mongos
$ docker run -d --net my-mongo-cluster -p 27017:27017 --name mongo1 mongo mongod --replSet my-mongo-set
$ docker run -d --net my-mongo-cluster -p 27018:27017 --name mongo2 mongo mongod --replSet my-mongo-set
$ docker run -d --net my-mongo-cluster -p 27019:27017 --name mongo3 mongo mongod --replSet my-mongo-set

# add hosts
$ sudo vi /private/etc/hosts
# hosts 파일에 내용 추가
127.0.0.1 mongo1 mongo2 mongo3
# dns cache 삭제하여 hosts 내용을 적용한다
$ dscacheutil -flushcache

# setup replica set
$ docker exec -it mongo1 mongo
# 여기부터는 mongo shell
> config = {"_id":"my-mongo-set", "members":[{"_id":0, "host":"mongo1:27017"}, {"_id":1, "host":"mongo2:27017"}, {"_id":2, "host":"mongo3:27017"}]}
> rs.initiate(config)

# connection URI
mongodb://localhost:27017,localhost:27018,localhost:27019/{db}?replicaSet=my-mongo-set

# secondary 에서 read 실행
# 책이나 블로그 등에서 가이드 하는 것들이 안먹어서 rs.help 를 통해 명령어 찾음 -> 이 명령어는 해당 노드로 이동후에만 사용 가능함
> rs.secondaryOk()
```

- rs는 복제 보조자 함수를 포함하는 전역 변수 (`rs.help()` : helper 확인)
  - 대부분 데이터베이스 명령을 감싸는 래퍼

- 클라이언트는 프라이머리 서버에 명령을 보낼 수 있다 (읽기, 쓰기, 명령, 인덱스 구축 등)
- 클라이언트는 세컨더리에 쓰기를 할 수 없다
- 기본적으로 클라이언트는 세컨더리로부터 읽을 수 없다. -> 활성화 가능

# 복제 셋 구성 변경
```javascript
// 새로운 멤버추가
> rs.add('localhost:27017')
// 멤버 제거
> rs.remove('localhost:27017')
// 현재 구성 출력
> rs.config()
// config 필드 직접수정
> config = rs.config()
> config.members[0].host = 'localhost:27017'
> rs.reconfig(config)
```
> config 변경시마다 version 필드값 증가

[MongoDB docker compose](https://smoh.tistory.com/419)