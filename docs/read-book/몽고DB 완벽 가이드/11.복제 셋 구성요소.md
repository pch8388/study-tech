# 동기화
동기화를 통해 복제 셋에 동일한 데이터 복사본을 유지
- 기본 작업이 수행하는 모든 쓰기(CUD)를 포함하는 작업로그 혹은 oplog를 유지
  - 프라이머리의 `local` 데이터베이스에 있는 제한된 컬렉션에 저장
  - 세컨더리는 복제할 작업에 대해 이 컬렉션을 조회
- 각 세컨더리는 자체 `oplog`를 유지/관리하고 프라이머리에서 복제하는 각 작업을 기록
  - 작업 적용이 실패하면 세컨더리가 종료된다
  - 세컨더리가 다운되면 재시작 시 `oplog`의 마지막 작업을 기준으로 동기화 시작
  - oplog 의 작업을 동기화(재실행)하는 것은 멱등성을 가진다

## oplog
- 기본적으로 고정된 크기로 특정 수의 작업만 보유 가능
- 데이터를 쓰는 속도와 거의 같은 속도로 `oplog`가 기록됨
  - 단, 삭제는 데이터를 지우기 때문에, `oplog`만 기록
- oplog 사이즈가 커야 하는 경우
  - 한 번에 여러 문서 업데이트
  - 삽입한만큼 삭제하는 경우
  - 도큐먼트 업데이트가 잦은 경우
- 레플리카 셋 구성시 `oplogSizeMB` 옵션으로 사이즈를 지정할 수 있다
- 이미 레플리카 셋이 구성되어 있다면 직접 레플라키 셋 멤버에 접근하여 수정해야 한다 [참고](https://docs.mongodb.com/manual/tutorial/change-oplog-size/)
  ```javascript
  // 세컨더리 쉘 접속 후
  // local db 사용
  use local
  // 현재 oplog 사이즈 확인
  db.oplog.rs.stats().maxSize
  // 변경 (예제는 16000MB)
  db.adminCommand({replSetResizeOplog:1, size:Double(16000)})
  ```

## 초기 동기화(Initial Sync)
레플리카 셋의 한 구성원에서 다른 구성원으로 모든 데이터를 복사

### 초기 동기화 과정
1. `local` 데이터베이스를 제외한 모든 데이터베이스 복제
2. `mongod`는 대상 멤버에게 복사할 데이터베이스의 모든 컬렉션과 데이터를 검색
3. 대상 멤버의 모든 데이터를 삭제
4. 데이터 복제
5. `mongod`는 복사 중 발생한 데이터에 대한 변경사항에 대한 `oplog`를 사용하여 대상 멤버에 적용

> 백업에서 복원하여 초기화 하는 것이 속도가 더 빠름
